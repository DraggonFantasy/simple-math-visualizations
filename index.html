<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥—Ä–æ–±—ñ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 900px;
            width: 100%;
        }

        h1 {
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .input-section {
            background: rgba(74, 85, 104, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }

        .fraction-inputs {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .fraction-input {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .fraction-input input {
            width: 60px;
            height: 40px;
            text-align: center;
            font-size: 1.2rem;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            margin: 2px 0;
            background: white;
        }

        .fraction-input .line {
            width: 60px;
            height: 2px;
            background: #4a5568;
            margin: 2px 0;
        }

        .operator {
            font-size: 2rem;
            color: #4a5568;
            font-weight: bold;
        }

        .equation {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #2d3748;
            font-weight: bold;
        }

        .chocolates-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .chocolate-wrapper {
            text-align: center;
        }

        .chocolate {
            width: 200px;
            height: 150px;
            background: #8B4513;
            border: 4px solid #654321;
            border-radius: 10px;
            position: relative;
            margin: 10px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .chocolate-piece {
            position: absolute;
            background: #8B4513;
            border: 1px solid #654321;
            transition: all 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chocolate-piece.highlighted {
            background: #FFD700;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px #FFD700;
            }
            to {
                box-shadow: 0 0 20px #FFD700, 0 0 30px #FFD700;
            }
        }

        .fraction-label {
            font-size: 1.5rem;
            margin-top: 10px;
            font-weight: bold;
            color: #2d3748;
        }

        .step-info {
            min-height: 140px;
            background: rgba(74, 85, 104, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.2rem;
            color: #4a5568;
            border-left: 5px solid #667eea;
        }

        .controls {
            margin-top: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.update {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .counting-number {
            position: absolute;
            font-size: 1.2rem;
            font-weight: bold;
            color: #e53e3e;
            animation: countPop 0.5s ease-out;
            z-index: 10;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            border: 2px solid #e53e3e;
        }

        @keyframes countPop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .result {
            font-size: 2.5rem;
            color: #38a169;
            font-weight: bold;
            margin-top: 30px;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .result.show {
            opacity: 1;
        }

        .plus-sign {
            font-size: 3rem;
            color: #4a5568;
            align-self: center;
            font-weight: bold;
        }

        .error {
            color: #e53e3e;
            font-size: 1rem;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .chocolates-container {
                flex-direction: column;
                align-items: center;
            }
            
            .plus-sign {
                transform: rotate(90deg);
                margin: 20px 0;
            }
            
            .fraction-inputs {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–î–æ–¥–∞–≤–∞–Ω–Ω—è –¥—Ä–æ–±—ñ–≤ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —à–æ–∫–æ–ª–∞–¥–æ–∫</h1>
        
        <div class="input-section">
            <div class="fraction-inputs">
                <div class="fraction-input">
                    <input type="number" id="num1" value="1" min="1" max="20">
                    <div class="line"></div>
                    <input type="number" id="den1" value="3" min="1" max="20">
                </div>
                
                <div class="operator">+</div>
                
                <div class="fraction-input">
                    <input type="number" id="num2" value="1" min="1" max="20">
                    <div class="line"></div>
                    <input type="number" id="den2" value="4" min="1" max="20">
                </div>
                
                <div class="operator">=</div>
                
                <div class="operator">?</div>
            </div>
            <button class="btn update" onclick="updateFractions()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –∞–Ω—ñ–º–∞—Ü—ñ—é</button>
            <div class="error" id="error"></div>
        </div>

        <div class="equation" id="equation">1/3 + 1/4 = ?</div>
        
        <div class="chocolates-container">
            <div class="chocolate-wrapper">
                <div class="chocolate" id="chocolate1"></div>
                <div class="fraction-label" id="fraction1">1/3</div>
            </div>
            
            <div class="plus-sign">+</div>
            
            <div class="chocolate-wrapper">
                <div class="chocolate" id="chocolate2"></div>
                <div class="fraction-label" id="fraction2">1/4</div>
            </div>
        </div>

        <div class="step-info" id="stepInfo">
            –í–≤–µ–¥—ñ—Ç—å –¥—Ä–æ–±–∏ –≤–∏—â–µ —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û–Ω–æ–≤–∏—Ç–∏ –∞–Ω—ñ–º–∞—Ü—ñ—é", –ø–æ—Ç—ñ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–∫—Ä–æ–∫–æ–≤–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É.
        </div>

        <div class="controls">
            <button class="btn" id="prevBtn" onclick="previousStep()" disabled>‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫—Ä–æ–∫</button>
            <button class="btn" id="nextBtn" onclick="nextStep()" disabled>–ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫ ‚Üí</button>
            <button class="btn" onclick="resetAnimation()">üîÑ –°–ø–æ—á–∞—Ç–∫—É</button>
        </div>

        <div class="result" id="result"></div>
    </div>

    <script>
        let currentStep = 0;
        const maxSteps = 4;
        let fractionData = null;
        let countingTimeouts = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–æ–≤
        
        // –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function gcd(a, b) {
            while (b !== 0) {
                let temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }

        function lcm(a, b) {
            return Math.abs(a * b) / gcd(a, b);
        }

        function reduceFraction(num, den) {
            const g = gcd(num, den);
            return [num / g, den / g];
        }

        function validateInputs() {
            const num1 = parseInt(document.getElementById('num1').value);
            const den1 = parseInt(document.getElementById('den1').value);
            const num2 = parseInt(document.getElementById('num2').value);
            const den2 = parseInt(document.getElementById('den2').value);
            
            if (isNaN(num1) || isNaN(den1) || isNaN(num2) || isNaN(den2)) {
                return "–£—Å—ñ –ø–æ–ª—è –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ —á–∏—Å–ª–∞–º–∏";
            }
            
            if (num1 < 1 || den1 < 1 || num2 < 1 || den2 < 1) {
                return "–£—Å—ñ —á–∏—Å–ª–∞ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0";
            }
            
            if (num1 > 20 || den1 > 20 || num2 > 20 || den2 > 20) {
                return "–ß–∏—Å–ª–∞ –Ω–µ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –±—ñ–ª—å—à–µ 20 (–¥–ª—è –∫—Ä–∞—â–æ—ó –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó)";
            }
            
            if (num1 >= den1 || num2 >= den2) {
                return "–ß–∏—Å–µ–ª—å–Ω–∏–∫–∏ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –º–µ–Ω—à–µ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫—ñ–≤ (—Ç—ñ–ª—å–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –¥—Ä–æ–±–∏)";
            }
            
            return null;
        }

        function updateFractions() {
            const error = validateInputs();
            const errorElement = document.getElementById('error');
            
            if (error) {
                errorElement.textContent = error;
                return;
            }
            
            errorElement.textContent = '';
            
            const num1 = parseInt(document.getElementById('num1').value);
            const den1 = parseInt(document.getElementById('den1').value);
            const num2 = parseInt(document.getElementById('num2').value);
            const den2 = parseInt(document.getElementById('den2').value);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª–µ–π –¥–ª—è –±–æ–ª–µ–µ –æ—á–µ–≤–∏–¥–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
            const commonDenom = den1 * den2;
            const newNum1 = num1 * den2;  // num1 * (commonDenom / den1)
            const newNum2 = num2 * den1;  // num2 * (commonDenom / den2)
            const resultNum = newNum1 + newNum2;
            
            // –û—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–º –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
            const [reducedNum, reducedDen] = reduceFraction(resultNum, commonDenom);
            
            fractionData = {
                original: {
                    num1, den1, num2, den2
                },
                common: {
                    num1: newNum1,
                    num2: newNum2,
                    den: commonDenom
                },
                result: {
                    num: resultNum,        // –Ω–µ—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π —á–∏—Å–ª–∏—Ç–µ–ª—å
                    den: commonDenom,      // –æ–±—â–∏–π –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å
                    reducedNum,            // —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π —á–∏—Å–ª–∏—Ç–µ–ª—å
                    reducedDen             // —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å
                }
            };
            
            document.getElementById('equation').textContent = 
                `${num1}/${den1} + ${num2}/${den2} = ?`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—É—é –¥—Ä–æ–±—å –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('result').textContent = 
                `${resultNum}/${commonDenom}`;
            
            currentStep = 0;
            resetAnimation();
            document.getElementById('nextBtn').disabled = false;
        }

        function getHighlightedPieces(rows, cols, numerator, denominator, isVertical) {
            const totalPieces = rows * cols;
            const piecesPerUnit = totalPieces / denominator;
            const highlightedCount = numerator * piecesPerUnit;
            
            const highlighted = [];
            
            if (isVertical) {
                // –í—ã–¥–µ–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã (–∫–æ–ª–æ–Ω–∫–∏)
                const colsToHighlight = numerator;
                for (let col = 0; col < colsToHighlight; col++) {
                    for (let row = 0; row < rows; row++) {
                        highlighted.push(row * cols + col);
                    }
                }
            } else {
                // –í—ã–¥–µ–ª—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã (—Ä—è–¥—ã)
                const rowsToHighlight = numerator;
                for (let row = 0; row < rowsToHighlight; row++) {
                    for (let col = 0; col < cols; col++) {
                        highlighted.push(row * cols + col);
                    }
                }
            }
            
            return highlighted;
        }

        function createChocolatePieces(chocolateId, rows, cols, highlightedPieces) {
            const chocolate = document.getElementById(chocolateId);
            chocolate.innerHTML = '';
            
            const pieceWidth = 100 / cols;
            const pieceHeight = 100 / rows;
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const piece = document.createElement('div');
                    piece.className = 'chocolate-piece';
                    piece.style.left = `${col * pieceWidth}%`;
                    piece.style.top = `${row * pieceHeight}%`;
                    piece.style.width = `${pieceWidth}%`;
                    piece.style.height = `${pieceHeight}%`;
                    
                    const pieceIndex = row * cols + col;
                    if (highlightedPieces.includes(pieceIndex)) {
                        piece.classList.add('highlighted');
                    }
                    
                    chocolate.appendChild(piece);
                }
            }
        }

        function getStepDescriptions() {
            if (!fractionData) return {};
            
            const { original, common } = fractionData;
            
            return {
                1: `–ö—Ä–æ–∫ 1: –î–≤—ñ —à–æ–∫–æ–ª–∞–¥–∫–∏ –æ–¥–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–æ–∑–º—ñ—Ä—É –ø–æ–¥—ñ–ª–µ–Ω—ñ –Ω–∞ ${original.den1} —ñ ${original.den2} —á–∞—Å—Ç–∏–Ω –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ. –ü—ñ–¥—Å–≤—ñ—á–µ–Ω—ñ ${original.num1}/${original.den1} —ñ ${original.num2}/${original.den2}.`,
                2: `–ö—Ä–æ–∫ 2: –î–æ–¥–∞—î–º–æ –ø–æ–¥—ñ–ª–∏ –¥–æ —Å–ø—ñ–ª—å–Ω–æ–≥–æ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫–∞ (${common.den}). –ú–∏ —Ü–µ —Ä–æ–±–∏–º–æ –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –≤—Å—ñ —à–º–∞—Ç–æ—á–∫–∏ –±—É–ª–∏ –æ–¥–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–æ–∑–º—ñ—Ä—É –Ω–∞ –æ–±–æ—Ö —à–æ–∫–æ–ª–∞–¥–∫–∞—Ö - —Ç–æ–¥—ñ –±—É–¥–µ –ª–µ–≥–∫–æ –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏. –ü—ñ–¥—Å–≤—ñ—á–µ–Ω—ñ –æ–±–ª–∞—Å—Ç—ñ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è —Ç–∏–º–∏ –∂ –∑–∞ —Ä–æ–∑–º—ñ—Ä–æ–º —ñ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è–º.`,
                3: `–ö—Ä–æ–∫ 3: –†–∞—Ö—É—î–º–æ –ø—ñ–¥—Å–≤—ñ—á–µ–Ω—ñ —à–º–∞—Ç–æ—á–∫–∏ –æ–¥–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–æ–∑–º—ñ—Ä—É. ${common.num1} + ${common.num2} = ${common.num1 + common.num2} —à–º–∞—Ç–æ—á–∫—ñ–≤.`,
                4: `–ö—Ä–æ–∫ 4: –û—Ç—Ä–∏–º—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${fractionData.result.num}/${fractionData.result.den}`
            };
        }

        function animateToStep(step) {
            if (!fractionData) return;
            
            // –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–∞–π–º–µ—Ä—ã
            countingTimeouts.forEach(timeout => clearTimeout(timeout));
            countingTimeouts = [];
            
            const stepInfo = document.getElementById('stepInfo');
            const result = document.getElementById('result');
            const fraction1 = document.getElementById('fraction1');
            const fraction2 = document.getElementById('fraction2');
            
            const descriptions = getStepDescriptions();
            stepInfo.textContent = descriptions[step] || '';
            
            // –£–¥–∞–ª—è–µ–º —á–∏—Å–ª–∞ –ø–æ–¥—Å—á–µ—Ç–∞
            document.querySelectorAll('.counting-number').forEach(num => num.remove());
            
            const { original, common } = fractionData;
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å–µ—Ç–∫–∏ –¥–ª—è –≤—Å–µ—Ö —à–∞–≥–æ–≤
            const finalRows1 = common.den / original.den1;
            const finalCols2 = common.den / original.den2;
            
            switch(step) {
                case 1:
                    // –ò—Å—Ö–æ–¥–Ω—ã–µ –¥—Ä–æ–±–∏
                    const highlighted1_step1 = getHighlightedPieces(1, original.den1, original.num1, original.den1, true);
                    const highlighted2_step1 = getHighlightedPieces(original.den2, 1, original.num2, original.den2, false);
                    
                    createChocolatePieces('chocolate1', 1, original.den1, highlighted1_step1);
                    createChocolatePieces('chocolate2', original.den2, 1, highlighted2_step1);
                    
                    fraction1.textContent = `${original.num1}/${original.den1}`;
                    fraction2.textContent = `${original.num2}/${original.den2}`;
                    result.classList.remove('show');
                    break;
                    
                case 2:
                    // –ê–Ω–∏–º–∞—Ü–∏—è –∫ –æ–±—â–µ–º—É –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—é
                    // –õ–µ–≤–∞—è —à–æ–∫–æ–ª–∞–¥–∫–∞: –¥–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –¥–µ–ª–µ–Ω–∏—è
                    let currentRows1 = 1;
                    const step1Interval = setInterval(() => {
                        currentRows1++;
                        const highlighted1 = getHighlightedPieces(currentRows1, original.den1, original.num1, original.den1, true);
                        createChocolatePieces('chocolate1', currentRows1, original.den1, highlighted1);
                        
                        const currentNum1 = original.num1 * currentRows1;
                        const currentDen1 = original.den1 * currentRows1;
                        fraction1.textContent = `${currentNum1}/${currentDen1}`;
                        
                        if (currentRows1 >= finalRows1) {
                            clearInterval(step1Interval);
                        }
                    }, 400);
                    
                    // –ü—Ä–∞–≤–∞—è —à–æ–∫–æ–ª–∞–¥–∫–∞: –¥–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –¥–µ–ª–µ–Ω–∏—è
                    setTimeout(() => {
                        let currentCols2 = 1;
                        const step2Interval = setInterval(() => {
                            currentCols2++;
                            const highlighted2 = getHighlightedPieces(original.den2, currentCols2, original.num2, original.den2, false);
                            createChocolatePieces('chocolate2', original.den2, currentCols2, highlighted2);
                            
                            const currentNum2 = original.num2 * currentCols2;
                            const currentDen2 = original.den2 * currentCols2;
                            fraction2.textContent = `${currentNum2}/${currentDen2}`;
                            
                            if (currentCols2 >= finalCols2) {
                                clearInterval(step2Interval);
                            }
                        }, 400);
                    }, 800);
                    break;
                    
                case 3:
                    // –§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞
                    const highlighted1_step3 = getHighlightedPieces(finalRows1, original.den1, original.num1, original.den1, true);
                    const highlighted2_step3 = getHighlightedPieces(original.den2, finalCols2, original.num2, original.den2, false);
                    
                    createChocolatePieces('chocolate1', finalRows1, original.den1, highlighted1_step3);
                    createChocolatePieces('chocolate2', original.den2, finalCols2, highlighted2_step3);
                    
                    fraction1.textContent = `${common.num1}/${common.den}`;
                    fraction2.textContent = `${common.num2}/${common.den}`;
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–¥—Å—á–µ—Ç–∞
                    setTimeout(() => {
                        animateCount();
                    }, 500);
                    break;
                    
                case 4:
                    // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                    const highlighted1_step4 = getHighlightedPieces(finalRows1, original.den1, original.num1, original.den1, true);
                    const highlighted2_step4 = getHighlightedPieces(original.den2, finalCols2, original.num2, original.den2, false);
                    
                    createChocolatePieces('chocolate1', finalRows1, original.den1, highlighted1_step4);
                    createChocolatePieces('chocolate2', original.den2, finalCols2, highlighted2_step4);
                    
                    fraction1.textContent = `${common.num1}/${common.den}`;
                    fraction2.textContent = `${common.num2}/${common.den}`;
                    result.classList.add('show');
                    break;
            }
        }

        function animateCount() {
            const chocolate1 = document.getElementById('chocolate1');
            const chocolate2 = document.getElementById('chocolate2');
            
            const pieces1 = chocolate1.querySelectorAll('.chocolate-piece.highlighted');
            const pieces2 = chocolate2.querySelectorAll('.chocolate-piece.highlighted');
            
            let count = 0;
            
            // –°—á–∏—Ç–∞–µ–º –ø–µ—Ä–≤—É—é —à–æ–∫–æ–ª–∞–¥–∫—É
            pieces1.forEach((piece, index) => {
                const timeout = setTimeout(() => {
                    count++;
                    addCountingNumber(piece, count);
                }, index * 400);
                countingTimeouts.push(timeout);
            });
            
            // –°—á–∏—Ç–∞–µ–º –≤—Ç–æ—Ä—É—é —à–æ–∫–æ–ª–∞–¥–∫—É
            pieces2.forEach((piece, index) => {
                const timeout = setTimeout(() => {
                    count++;
                    addCountingNumber(piece, count);
                }, (pieces1.length + index) * 400);
                countingTimeouts.push(timeout);
            });
        }

        function addCountingNumber(piece, number) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ DOM
            if (!piece || !piece.parentElement || !document.contains(piece)) {
                return;
            }
            
            const numberElement = document.createElement('div');
            numberElement.className = 'counting-number';
            numberElement.textContent = number;
            
            try {
                const rect = piece.getBoundingClientRect();
                const containerRect = piece.parentElement.getBoundingClientRect();
                
                // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
                const centerX = rect.left - containerRect.left + (rect.width / 2) - 10;
                const centerY = rect.top - containerRect.top + (rect.height / 2) - 10;
                
                numberElement.style.left = `${centerX}px`;
                numberElement.style.top = `${centerY}px`;
                
                piece.parentElement.appendChild(numberElement);
            } catch (error) {
                // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º, –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º —á–∏—Å–ª–æ
                console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ —á–∏—Å–ª–æ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É:', error);
            }
        }

        function nextStep() {
            if (currentStep < maxSteps && fractionData) {
                currentStep++;
                animateToStep(currentStep);
                updateButtons();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                animateToStep(currentStep);
                updateButtons();
            }
        }

        function resetAnimation() {
            // –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ —Ç–∞–π–º–µ—Ä—ã
            countingTimeouts.forEach(timeout => clearTimeout(timeout));
            countingTimeouts = [];
            
            if (fractionData) {
                currentStep = 1;
                animateToStep(currentStep);
            } else {
                currentStep = 0;
            }
            updateButtons();
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (!fractionData) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            prevBtn.disabled = currentStep <= 1;
            nextBtn.disabled = currentStep >= maxSteps;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateFractions();
    </script>
</body>
</html>
